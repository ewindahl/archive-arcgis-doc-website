require(["Config","dojo/query","dojo/dom-form","dojo/dom-construct","dojo/io-query","dojo/ready","dojo/cookie"],function(e,t,n,r,i,s,o){function d(){t("#submitBtn").attr("disabled",!0),t("#legalTerms").attr("checked",!1)}function v(n){if(!n||!n.match(a))return;esri.request({url:e.billing+"/p/checkUsername",content:{username:n,f:"json"},handleAs:"json"}).then(function(e){dojo.trim(e+"")==="true"?u=!0:(u=!1,t("#usernameMessage").removeClass("hide"))},function(e){u=!0})}function m(t){esri.request({url:e.portal+"/rest/portals/regions",content:{f:"json"},handleAs:"json"}).then(function(e){try{e.some(function(e){if(e.region==t)return c.region=e.region,!0})}catch(n){}},function(e){})}function g(t){esri.request({url:e.portal+"/rest/portals/languages",content:{f:"json"},handleAs:"json"}).then(function(e){var n=y(t,e);n.length>0&&(c.culture=n)},function(e){})}function y(e,t){var n="",r="",i=e.length;return e=e.replace("_","-").toLowerCase(),t.some(function(t){r=t.culture.substr(0,i).toLowerCase();if(e==r)return n=t.culture,!0}),n.length==0&&i>2&&(n=y(e.substr(0,2),t)),n}function b(){var e=!0;return t(".error-message.server-error").remove(),t(".error").removeClass("error"),u||(e=!1,t("input[name='username']").addClass("error")),h.password.match(f)?h.password!==h.confirmationPassword&&(e=!1,t("input[name='confirmationPassword']").addClass("error")):(e=!1,t("input[name='password']").addClass("error")),h.shortname||(e=!1,t("input[name='shortname']").addClass("error")),h.identity_question||(e=!1,t("select[name='identity_question']").addClass("error")),h.identifyAnswer||(e=!1,t("input[name='identifyAnswer']").addClass("error")),e}function w(e){e=e||"We were unable to complete your request at this time.",r.create("div",{"class":"error-message server-error",innerHTML:e},"submitBtn","before");var n=t("#legalTerms").attr("checked")?!0:!1;t("#submitBtn").attr("disabled",!n).attr("value","Create My Account")}function E(e){e&&(p=e),t("#submitBtn").attr("disabled",!0).attr("value","Creating account...");switch(p){case STEP_GLOBAL_ACCOUNT:x();break;case STEP_AGOL_ACCOUNT:T();break;case STEP_ACTIVATION:N(c.culture,c.region);break;case STEP_SETTINGS:C();break;case STEP_LOGIN:k();break;case STEP_VALIDATION:default:S()}}function S(){h.firstName=c.firstName,h.lastName=c.lastName,h.email=c.email,h.identifyQuestion=t("select[name='identity_question'] > option:checked").text(),h.identifyQuestionID=h.identity_question,h.phoneNumber="-",h.format="json",h.languageCode="en",h.organization.length<1&&(h.organization="Individual"),esri.request({url:e.billing+"/p/cAccount",content:h,handleAs:"json"},{usePost:!0}).then(function(e){if(e&&e.hasOwnProperty("status")&&e.status.toLowerCase()=="success"&&e.hasOwnProperty("token"))E(STEP_GLOBAL_ACCOUNT);else{var n=e.errorcode.toLowerCase();if(n=="username_taken")w("Username has already been taken, please choose another.");else{if(n=="delayed_creation"){t("#delayed-account").removeClass("hide");return}w()}}},function(e){if(e.hasOwnProperty("errorcode")&&e.errorcode.toLowerCase()=="delayed_creation"){t("#delayed-account").removeClass("hide");return}w()})}function x(){esri.request({url:e.portal+"/rest/community/signup",content:{username:h.username,password:h.password,email:h.email,fullname:c.firstName+" "+c.lastName,securityQuestionIdx:h.identifyQuestionID,securityAnswer:h.identifyAnswer,activationCode:l,referer:location.host,provider:"ecas",f:"json"},handleAs:"json"},{usePost:!0}).then(function(e){e&&e.success&&e.hasOwnProperty("token")?(c.token=e.token,E(STEP_AGOL_ACCOUNT)):w()},function(e){w()})}function T(){esri.request({url:e.portal+"/rest/portals/activate",content:{token:c.token,code:l,f:"json"},handleAs:"json"},{usePost:!0}).then(function(e){e&&e.success?E(STEP_ACTIVATION):w()},function(e){w()})}function N(t,n){esri.request({url:e.portal+"/rest/portals/self/update",content:{token:c.token,urlKey:h.shortname,region:n,culture:t,f:"json"},handleAs:"json"},{usePost:!0}).then(function(e){E(STEP_SETTINGS)},function(e){e.message.toLowerCase()=="url key already in use."?w("Please choose a different account URL path, the one provided is not available."):w()})}function C(){esri.request({url:e.portal+"/rest/portals/self/",content:{token:c.token,f:"json"},handleAs:"json"}).then(function(e){var t=Number(new Date)+TOKEN_EXPIRATION_MS,n={expires:t,path:"/",domain:window.location.hostname};e.allSSL&&(n.secure=!0),o("esri_auth",JSON.stringify({accountId:e.id,culture:e.culture,email:e.user.username,expires:t,region:e.region,role:e.user.role,token:c.token,urlKey:e.urlKey}),n),E(STEP_LOGIN)},function(e){E(STEP_LOGIN)})}function k(){window.location="/"+dojo.locale.substr(0,2)+"/applications/"}STEP_VALIDATION=0,STEP_GLOBAL_ACCOUNT=1,STEP_AGOL_ACCOUNT=2,STEP_ACTIVATION=3,STEP_SETTINGS=4,STEP_LOGIN=5,TOKEN_EXPIRATION_DAYS=14,TOKEN_EXPIRATION_MS=TOKEN_EXPIRATION_DAYS*24*60*60*1e3;var u=!1,a=/^([a-zA-Z\d]{6,24})$/,f=/^([a-zA-Z\d]{8,28})$/,l="",c={token:"",region:"WO",culture:"EN",firstName:"",lastName:"",email:""},h={},p=STEP_VALIDATION;s(function(){d();var n=window.location.search,r=n.substring(n.indexOf("?")+1,n.length),s=i.queryToObject(r);if(s.hasOwnProperty("activationCode"))l=s.activationCode;else{if(!s.hasOwnProperty("activationcode")){t("#loading-message").addClass("hide"),t("#invalid-code").removeClass("hide");return}l=s.activationcode}v(t("#username").val()),esri.request({url:e.billing+"/subscription/info",content:{activationToken:dojo.trim(l),f:"json"},handleAs:"json"}).then(function(e){try{t("#loading-message").addClass("hide"),e.code==200?(t("#signup-wrapper").removeClass("hide"),c.firstName=e.firstName,c.lastName=e.lastName,c.email=e.email,t("#user-firstName").html(c.firstName),t("#user-lastName").html(c.lastName),e.countryCode.length>0&&m(e.countryCode),e.locale.length>0&&g(e.locale)):e.code==500&&e.message.toLowerCase()=="activation token not found"?t("#invalid-code").removeClass("hide"):e.code==500&&e.message.toLowerCase()=="activation token used"?t("#activated-code").removeClass("hide"):t("#error-message").removeClass("hide")}catch(n){t("#error-message").removeClass("hide")}},function(e){t("#loading-message").addClass("hide"),t("#error-message").removeClass("hide")})}),t("#userName").on("change",function(e){u=!1,t("#usernameMessage").addClass("hide"),v(t(e.target).val())}),t("input[name='legalTerms']").on("change",function(e){t("#submitBtn").attr("disabled",!e.target.checked)}),t("#signup-form").on("submit",function(e){e.preventDefault(),e.stopImmediatePropagation(),h=n.toObject("signup-form");if(!b()){w("Please validate all form fields");return}E()})});