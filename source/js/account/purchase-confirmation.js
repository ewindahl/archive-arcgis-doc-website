require(["Config","SessionManager","dojo/query","/js/account/new-plan-summary.js"],function(e,t,n,r){function a(){var e=o[0],r=f(e.type)||"error-no-type",i=r.toUpperCase()!="MC"?l(r)+" Card":l(r),s=e.cardHolderName||"error-no-name",a=e.externalToken||"error-no-digits",c=e.expirationMonth||"00",h=e.expirationYear||"00",p=c+"/"+h,d="Card ending in "+a,v="Expires "+p;n("#payment-cc-type").html(i),n("#payment-cc-full-name").html(s),n("#payment-cc-four").html(d),n("#payment-cc-expires").html(v),n("#payment-address").html(e.address.streetAddress);var m=e.address.city;e.address.state.length?m+=", "+e.address.state:e.address.country.length&&(m+=", "+e.address.country),e.address.postalCode.length&&(m+=" "+e.address.postalCode),n("#payment-city").html(m);var g=parseFloat(u.subTotal)+parseFloat(u.tax);n("#plan-name").innerHTML(subscription.product.credits+" credits, $"+subscription.product.price+" / month"),n("#plan-price").innerHTML("$"+parseFloat(u.subTotal)),n("#plan-tax").innerHTML("$"+parseFloat(u.tax)),n("#plan-total").innerHTML("$"+g),n("#subscription-id").innerHTML("Subscription ID: "+t.organization.subscriptionInfo.id),n("#loading-message").addClass("hide"),n("#order-confirmation").removeClass("hide"),n("#plan-summary").removeClass("hide")}function f(e){var t=e.split(" "),n=["and","the","in","an","or","at","of","a"],r="",i="";for(index in t)i=t[index],n.indexOf(i)==-1?r+=" "+i.substr(0,1).toUpperCase()+i.substring(1).toLowerCase():r+=" "+i;return r.substring(1)}function l(e){return e.toUpperCase()!="MC"?e:"Master Card"}function c(){n("#loading-message").addClass("hide"),n("#order-confirmation").addClass("hide"),n("#error-message").removeClass("hide")}function h(e){n("#non-fatal-error").removeClass("hide"),n("#submitBtn").attr("disabled",!1)}function p(){esri.request({url:e.billing+"/storage/",content:{id:s,userToken:t.token(),f:"json"},handleAs:"json"}).then(function(e){e.code==200?(i=JSON.parse(e.value),d(),r.loadSubscription(i.selectedPlan,t.token())):c()},function(e){c()})}function d(){var n=t.token(),r=i.creditCardID||0;if(r===0){c();return}esri.request({url:e.billing+"/cc/ecomm/billing/",content:{token:n,id:r,f:"json"},handleAs:"json"}).then(function(e){e.code==200?(o=e.cards,v()):c()},function(e){c()})}function v(){esri.request({url:e.billing+"/ecomm/pricing/"+i.selectedPlan,content:{"card-id":i.creditCardID,token:t.token(),f:"json"},handleAs:"json"}).then(function(e){e.code==200?(u=e,a()):c()},function(e){c()})}function m(){n("#error-message").addClass("hide"),esri.request({url:e.billing+"/ecomm/purchase/",content:{id:i.selectedPlan,"allow-overage":i.allowOverage,"card-id":i.creditCardID,token:t.token(),f:"json"},handleAs:"json"},{usePost:!0}).then(function(e){e.code==200?(n("#submit-buttons").addClass("hide"),n("#finalized-buttons").removeClass("hide"),e.type=="Upgrade"||e.type=="Purchase"?n("#upgrade-success").removeClass("hide"):e.type=="Downgrade"&&n("#downgrade-success").removeClass("hide")):h("There was an error completing your purchase. Please contact customer service.")},function(e){h()})}var i,s="subscription-signup",o,u;t.queue(p),n("#submitBtn").on("click",function(e){n("#error-message").addClass("hide"),n(e.target).attr("disabled",!0),m()})});