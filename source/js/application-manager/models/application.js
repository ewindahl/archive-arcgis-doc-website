define(["SessionManager","Config","dojo/_base/declare","dojo/_base/lang","dojo/Deferred","Quoin/Model","ApplicationManager/helpers/usage"],function(e,t,n,r,i,s,o){return n([s],{path:t.portal+"/rest/content/users/"+e.username(),getters:{canViewStats:function(){var t=!1;if(e.username()===this.get("owner")||e.role()==="admin")t=!0;return t},canEdit:function(){var t=!1;if(e.username()===this.get("owner")||e.role()==="admin")t=!0;return t}},postMixInProperties:function(){this.addHelper("ifForApplication",r.hitch(this,function(e){return this.model.get("forApplication")?e.fn(this):e.inverse(this)}))},serviceUsage:[],getFolder:function(){var e=new i;return this.get("folderInfo")||this.get("folderInfo")===null?e.resolve(this.get("folderInfo")):esri.request({url:t.portal+"/rest/content/items/"+this.get("id"),content:{f:"json"}}).then(r.hitch(this,function(t){t.ownerFolder?esri.request({url:this.path+"/"+t.ownerFolder+"?f=json"}).then(r.hitch(this,function(t){this.set("folderInfo",t),e.resolve(t)})):(this.set("folderInfo",null),e.resolve())})),e},getUsageData:function(t){var n=new i;return this.getOauthInfo().then(r.hitch(this,function(i){o.getUsageDataForGraph(e.orgId(),t,i.client_id).then(r.hitch(this,function(e){this.set("serviceUsage",e.usageData),this.set("creditsUsed",e.creditsUsed),this.set("averagePerDay",e.averagePerDay),n.resolve(e)}))})),n},getOauthInfo:function(){var e=new i;return this.get("oAuthInfo")?e.resolve(this.get("oAuthInfo")):this.getFolder().then(r.hitch(this,function(t){var n=t?"/"+t.currentFolder.id+"/items/":"/items/";esri.request({url:this.path+n+this.get("id")+"/registeredAppInfo",content:{f:"json"}}).then(r.hitch(this,function(t){this.set("oAuthInfo",t),this.set("apnsProdCert",t.apnsProdCert),this.set("apnsSandboxCert",t.apnsSandboxCert),this.set("gcmApiKey",t.gcmApiKey),e.resolve(t)}),r.hitch(this,function(t){e.reject(t)}))})),e},create:function(){this.inherited(arguments);var e=new dojo.Deferred,t=this.get("redirect_uris")?this.get("redirect_uris"):!1;t&&this.set({oAuthInfo:{redirect_uris:t}});var n=this.get("tags");return esri.request({url:this.path+"/addItem",content:{type:this.get("type"),title:this.get("title"),description:this.get("description"),tags:n?n.join(","):"",f:"json"}},{usePost:!0}).then(r.hitch(this,function(t){this.set("id",t.id),this.registerApp(!0).then(r.hitch(this,function(){e.resolve(this)}),function(t){e.reject(t)})}),function(t){e.reject(t)}),e},handleRegisrationError:function(e,t){e.message==="Not a registered app"?this.registerApp(!0).then(function(){t.resolve(this)},function(){t.reject(this)}):t.reject(this)},registerApp:function(e){var n,s,o=new i,u=this.get("oAuthInfo")?this.get("oAuthInfo").client_id:!1,a=this.get("oAuthInfo")?this.get("oAuthInfo").redirect_uris:[];a?s=JSON.stringify(a):s="[]";var f={itemId:this.get("id"),appType:"multiple",redirect_uris:s,f:"json"};return u&&!e?this.getOauthInfo().then(function(e){n=t.portal+"/oauth2/apps/"+e.client_id+"/update",esri.request({url:n,content:f},{usePost:!0}).then(r.hitch(this,function(){o.resolve(this)}),r.hitch(this,function(e){}))},r.hitch(this,function(e){this.handleRegisrationError(e,o)})):a.length||e?(n=t.portal+"/oauth2/registerApp",esri.request({url:n,content:f},{usePost:!0}).then(r.hitch(this,function(e){this.set("oAuthInfo",e),o.resolve(this)}),r.hitch(this,function(){o.reject(this)}))):o.resolve(this),o},update:function(){var e=new i;return this.inherited(arguments),this.getFolder().then(r.hitch(this,function(t){var n=t?"/"+t.currentFolder.id+"/items/":"/items/";esri.request({url:this.path+n+this.get("id")+"/update",content:{title:this.get("title"),description:this.get("description")||"",tags:this.get("tags").join(","),clearEmptyFields:"true",f:"json"}},{usePost:!0}).then(r.hitch(this,function(){e.resolve(this)}))})),e},destroy:function(){return this.inherited(arguments),esri.request({url:this.path+"/deleteItems",content:{items:this.get("id"),f:"json"}},{usePost:!0})},sync:function(){this.inherited(arguments)}})});