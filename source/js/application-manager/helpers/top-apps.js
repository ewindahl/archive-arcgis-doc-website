define(["Config","SessionManager","dojo/Deferred","dojo/_base/lang","dojo/promise/all"],function(e,t,n,r,i){function s(e){var t=[];if(e.length)for(k=0;k<e.length;k++){var n=parseFloat((parseFloat(e[k].credits[0][1])+parseFloat(e[k].credits[1][1])).toFixed(2));(n>0||!e[k].name||!e[k].appId)&&t.push({appId:e[k].appId,credits:n})}t.sort(function(e,t){return t.credits-e.credits}),t.splice(10,t.length-10);for(j=0;j<t.length;j++)t[j].percent=(t[j].credits/t[0].credits*100).toFixed(0);return t}function o(e){switch(e){case"week":return"Last 7 Days";case"month":return"Last 30 Days";case"half_year":return"Last 6 Months";case"year":return"Last Year"}}function u(e){var n=new Date,r=864e5,i=30*r,s="1d";switch(e){case"week":i=r*7,s="7d";break;case"month":i=r*30,s="30d";break;case"half_year":i=r*183,s="183d";break;case"year":i=r*365,s="365d"}return{vars:"credits",startTime:n.setHours(0,0,0,0)-i,endTime:n.getTime(),groupby:"appid",f:"json",appOrgId:t.orgId(),period:s}}return{getAppData:function(t,r){var a=new n;return esri.request({url:e.portal+"/portals/"+t+"/usage",content:u(r)}).then(function(t){var n;if(!t.data.length){a.resolve({timeRangePhrase:u(r)[1],mostCredits:0,appUsageData:[]});return}n=s(t.data);var f=n[0].credits,l=[];for(var c=0;c<n.length;c++)l.push(esri.request({url:e.portal+"/oauth2/apps/"+n[c].appId,content:{f:"json"}}));i(l).then(function(t){var s=[];for(var u=0;u<t.length;u++){var l=t[u];for(var c=0;c<n.length;c++)n[c].appId===l.client_id&&(n[c].itemId=l.itemId);s.push(esri.request({url:e.portal+"/rest/search",content:{q:"id:"+t[u].itemId,f:"json"}}))}i(s).then(function(e){for(var t=0;t<e.length;t++){var i=e[t].results[0];for(var s=0;s<n.length;s++)n[s].itemId===i.id&&(n[s].name=i.title)}a.resolve({timeRangePhrase:o(r),mostCredits:f,appUsageData:n})},function(){a.reject(error)})},function(){a.reject(error)})},function(e){a.reject(e)}),a}}});