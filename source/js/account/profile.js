require(["Config","SessionManager","Notifications","dojo/query","dojo/dom-form","dojo/dom-construct","dojo/NodeList-traverse"],function(e,t,n,r,s,o){function h(){r("#loading-message").addClass("hide"),r("#content-wrapper").removeClass("hide"),b(),E(),w(),d()}function p(){u=s.toObject("profile-form");if(!v()){y("Please validate all form fields");return}a=0,f=0,r("#submitProfileBtn").attr("disabled",!0),S(u),x(u)}function d(){var e=t.profile,n=e.fullName.split(" ");r("#profile-owner").innerHTML(n[0]+"&apos;s Profile"),r("input[name='firstName']").val(n[0]||""),r("input[name='lastName']").val(n[1]||""),r("input[name='email']").val(e.email),r("#userName").html(e.username);var i=t.organization,s=i.urlKey+"."+i.customBaseUrl,o=i.allSSL===!0?"https://":"http://";r("#account-url").html(s).attr("href",o+s),r("#subscription-id").html(i.subscriptionInfo.id),r("#regionSelector").children("option[value*="+i.region+"]").attr("selected","selected"),r("#cultureSelector").children("option[value*="+i.culture+"]").attr("selected","selected")}function v(){var e=!0;r(".error").removeClass("error"),r("#profileNotifications").empty(),u.firstName||(e=!1,r("input[name='firstName']").addClass("error")),u.lastName||(e=!1,r("input[name='lastName']").addClass("error")),u.email||(e=!1,r("input[name='email']").addClass("error"));if(!!u.identity_question||!!u.identifyAnswer)u.identity_question||(e=!1,r("select[name='identity_question']").addClass("error")),u.identifyAnswer||(e=!1,r("input[name='identifyAnswer']").addClass("error"));return e}function m(e,t){var n=r('select[name="'+e+'"]')[0];for(var i=0;i<n.length;i++)if(n.options[i].value.toUpperCase()==t.toUpperCase()){n.selectedIndex=i;break}}function g(e){e===!0?a++:f++;var t=a+f;t>=l&&(f==0?y("Your profile has been updated","success"):y(),r("#submitProfileBtn").attr("disabled",!1))}function y(e,t){e=e||"We were unable to complete your request at this time.",t=t||"error",r("#profileNotifications").empty();var i=new n(r("#profileNotifications"));i[t](e)}function b(){var n=t.organization.region||"WO";esri.request({url:e.portal+"/rest/portals/regions?f=json",handleAs:"json"}).then(function(e){e.forEach(function(e){o.create("option",{value:e.region,innerHTML:e.localizedName},"regionSelector")}),m("region",n)},function(e){c=!0,r("#arcgisForm").addClass("hide")})}function w(){esri.request({url:e.billing+"/subscription/preferences/communications",content:{token:t.token(),f:"json"}}).then(function(e){if(e.code=="200")for(i=0;i<e.communicationPreferences.length;i++){var t='<li><label><input type="checkbox" name="communicationpreferences" value="'+e.communicationPreferences[i].description+'"'+(e.communicationPreferences[i].status==1?"checked":"")+"> "+e.communicationPreferences[i].description+"</label></li>";o.place(o.toDom(t),"communicationsul")}else showFatalError()},function(e){showFatalError()})}function E(){var n=t.organization.culture||"EN";esri.request({url:e.portal+"/rest/portals/languages?f=json",handleAs:"json"}).then(function(e){e.forEach(function(e){o.create("option",{value:e.culture,innerHTML:e.localizedName},"cultureSelector")}),m("language",n)},function(e){c=!0,r("#arcgisForm").addClass("hide")})}function S(n){var r="";dojo.query("[name=communicationpreferences]").forEach(function(e){e.checked&&(r=r+e.value+";")}),esri.request({url:e.billing+"/subscription/preferences/communications",content:{token:t.token(),firstName:n.firstName,lastName:n.lastName,email:n.email,passwordQuestionID:n.identity_question,passwordAnswer:n.identifyAnswer,communications:r,f:"json"},handleAs:"json"},{usePost:!0}).then(function(e){e.status=="success"?g(!0):g(!1)},function(e){g(!1)})}function x(n){c===!0&&g(!0),esri.request({url:e.portal+"/rest/portals/self/update",content:{token:t.token(),region:n.region,culture:n.language,f:"json"},handleAs:"json"},{usePost:!0}).then(function(e){e.success===!0?g(!0):g(!1)},function(e){g(!1)})}var u={},a=0,f=0,l=2,c=!1;t.queue(h),r("#profile-form").on("submit",function(e){e.preventDefault(),e.stopImmediatePropagation(),p()})});