define(["SessionManager","Config","dojo/Deferred","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/topic","Quoin/Collection","ApplicationManager/models/application"],function(e,t,n,r,i,s,o,u,a){processTags=function(e){var t=e?e.split(","):[];for(var n=0;n<t.length;n++)t[n].replace(/^\s\s*/,"").replace(/\s\s*$/,"");return t},processRedirects=function(e){return typeof e=="string"&&(e=[e]),s.filter(e,function(e){return!!e.length})};var f=r([u],{loaded:!1,perPage:100,start:1,fetch:function(r){var s=r?'"'+r+'" AND ':"",o="owner:"+e.username(),u=new n;return esri.request({url:t.portal+"/rest/search",content:{f:"json",q:s+o+' AND (type:"Web Mapping Application" OR type:"Mobile Application" OR type:"Application")',sortField:"created",sortOrder:"desc",num:s?100:this.perPage,start:s?1:this.start}}).then(i.hitch(this,function(e){for(var t=e.results.length-1;t>=0;t--)if(!this.get(e.results[t].id)){var n=new this.model(e.results[t]);this.add(n)}this.loaded=!0,0<this.start&&(this.start=e.nextStart,this.total=e.total),this.emit("applications:fetched"),this.publish("applications:loaded"),u.resolve()})),u},getOrFetch:function(r){var s=new n;return this.get(r)?s.resolve(this.get(r)):esri.request({url:t.portal+"/rest/search",content:{f:"json",q:"id:"+r+" AND owner:"+e.username()+' AND (type:"Web Mapping Application" OR type:"Mobile Application" OR type:"Application")'}}).then(i.hitch(this,function(e){this.get(r)?s.resolve(this.get(r)):(model=new this.model(e.results[0]),this.add(model),s.resolve(model))})),s},more:function(){return 0<this.start},register:function(e){return this.get(e).registerApp(!0)}}),l=new f({model:a});return l.subscribe("application:new",function(t){t.redirect_uris=processRedirects(t.redirect_uris),t.tags&&(t.tags=processTags(t.tags)),t.type="Application",t.owner=e.username(),this.create(t).then(i.hitch(this,function(e){this.publish("application:created"),this.publish("router:navigate",e.get("id")+"/info")}),function(e){l.publish("application:create-failed",e)})}),l.subscribe("application:destroy",function(e){this.get(e).destroy().then(function(){l.publish("router:navigate","/"),l.publish("application:deleted")},function(){l.publish("application:delete-failed")})}),l.subscribe("application:update",function(e,t){var n=this.get(e),r=n.get("oAuthInfo")||{};r.redirect_uris=processRedirects(t.redirect_uris),console.log(r),n.set({title:t.title||n.get("title"),description:typeof t.description=="undefined"||!t.description.length?"":t.description,oAuthInfo:r,tags:typeof t.tags=="undefined"||!t.tags.length?[]:processTags(t.tags),apnsSandboxCert:t.apnsSandboxCert||n.get("apnsSandboxCert"),apnsProdCert:t.apnsProdCert||n.get("apnsProdCert"),gcmApiKey:t.gcmApiKey||n.get("gcmApiKey")}),n.update().then(function(){n.registerApp().then(function(){l.publish("application:updated",n)},function(){l.publish("application:update-failed",n)})},function(){l.publish("application:update-failed",n)})}),l});