define(["dojo/_base/declare","Config","SessionManager","Notifications","dojo/query","dojo/dom-form","dojo/dom-construct","dojo/topic"],function(e,t,n,r,i,s,o,u){function d(){x()}function v(e){return dojo.trim(JSON.stringify(e))}function m(e,t){var n=i('select[name="'+e+'"]')[0];for(var r=0;r<n.length;r++)if(n.options[r].value==t){n.selectedIndex=r;break}}function g(){y(),T()}function y(){var e=i("#countrySelector").val()||"";a.indexOf(e)>-1?i("#vat-wrapper").removeClass("hide"):(i("#vat-wrapper").addClass("hide"),i('input[name="vat"]').val(""))}function b(){i("#regionSelector option").forEach(o.destroy),o.create("option",{value:"none",innerHTML:"No states or provinces are available"},"regionSelector")}function w(){var e=!0;i(".error-message.server-error").remove(),i(".error").removeClass("error"),formFields.nameOnCard||(e=!1,i("input[name='nameOnCard']").addClass("error")),formFields.address||(e=!1,i("input[name='address']").addClass("error")),formFields.city||(e=!1,i("input[name='city']").addClass("error")),formFields.postalCode||(e=!1,i("input[name='postalCode']").addClass("error")),formFields.country||(e=!1,i("select[name='country']").addClass("error")),formFields.state?formFields.state.toLowerCase()=="none"&&(formFields.state=""):(e=!1,i("select[name='state']").addClass("error"));if(a.indexOf(formFields.country)>-1){var t;formFields.vat.indexOf(formFields.country)==0?t=formFields.vat:t=formFields.country+formFields.vat,checkVATNumber(t)||(e=!1,i("input[name='vat']").addClass("error"))}return e}function E(e){var t=0;switch(e.toLowerCase()){case"amex":t=3e3;break;case"visa":t=4e3;break;case"mc":t=5e3;break;case"disc":t=6e3}return t}function S(e){e=e||"We were unable to complete your request at this time.",i("#cc-notifications").empty();var t=new r(i("#cc-notifications"));t.error(e)}function x(e){var n=e||"US";esri.request({url:t.billing+"/survey/countries",handleAs:"json"}).then(function(e){e.countries.forEach(function(e){try{var t=o.create("option",{value:e.code,innerHTML:e.name},"countrySelector");e.code.toUpperCase()==n&&t.setAttribute("selected","selected")}catch(r){showFatalError()}}),y(),T()},function(e){showFatalError()})}function T(){var e=i("#countrySelector").val()||"";if(dojo.trim(e).length!=2)return;esri.request({url:t.billing+"/p/common?url="+t.ecas+"/output/common/isoCountryDb/json/regions/"+e+".json",handleAs:"json"}).then(function(e){i("#regionSelector option").forEach(o.destroy),o.create("option",{value:"",innerHTML:"Please select a state / region / province",selected:"selected"},"regionSelector"),e.regions.forEach(function(e){try{o.create("option",{value:e.code,innerHTML:e.name},"regionSelector")}catch(t){b()}}),h&&h.address&&m("state",h.address.state)},function(e){b()})}var a="AT,BE,BG,CY,CZ,DE,DK,EE,ES,FI,FR,GB,GR,HU,IE,IT,LT,LU,LV,MT,NL,PL,PT,RO,SE,SI,SK",f="",l,c="",h=null,p=e([],{populateForm:function(e){h=e,i('input[name="nameOnCard"]').val(e.cardHolderName),i('input[name="address"]').val(e.address.streetAddress),i('input[name="city"]').val(e.address.city),i('input[name="postalCode"]').val(e.address.postalCode),i('input[name="vat"]').val(e.address.vat),i('input[name="default"]')[0].checked=!1,m("country",e.address.country),g(),i('input[type="text"]').removeClass("error"),i("select").removeClass("error"),i("#cc-notifications").empty(),i("#submitBtn").val("Modify Payment Method"),i("#default-container").addClass("hide"),i("#card-action").html("Modify"),c="",this.callCreditCardForm("repopulateCreditCardForm",[{Paymetric_CreditCardType:E(e.type),Paymetric_CreditCardNumber:"XXXXXXXXXXXX"+e.externalToken,Paymetric_Exp_Month:e.expirationMonth,Paymetric_Exp_Year:e.expirationYear,Paymetric_CVV:""}])},clearForm:function(e){i('input[type="text"]').val("").removeClass("error"),i("select").val("").removeClass("error"),i('input[name="default"]')[0].checked=!0,m("country","US"),h=null,i("#cc-notifications").empty(),i("#submitBtn").val("Add Payment Method"),i("#default-warning").empty(),i("#card-action").html("Add"),c="",e?i("#default-container").removeClass("hide"):i("#default-container").addClass("hide"),this.callCreditCardForm("repopulateCreditCardForm",[{Paymetric_CreditCardType:3e3,Paymetric_CreditCardNumber:"",Paymetric_Exp_Month:"",Paymetric_Exp_Year:"",Paymetric_CVV:""}])},callCreditCardForm:function(e,t){var n=document.getElementById("credit-frame").contentWindow;if(n&&n.hasOwnProperty(e))return n[e].apply(n,t)}});return n.queue(d),i("#countrySelector").on("change",g),i("#payment-form").on("submit",function(e){e.preventDefault(),e.stopImmediatePropagation(),formFields=s.toObject("payment-form");if(!w(formFields)){S("Please validate all billing address fields");return}var t=f;f=v(formFields);var n=v(esri.paymentForm.callCreditCardForm("getCreditCardValues"));i("#submitBtn").attr("disabled",!0);if(h!=null){var r=esri.paymentForm.callCreditCardForm("getCreditCardValues");formFields.expMon=r.Paymetric_Exp_Month,formFields.expYear=r.Paymetric_Exp_Year,u.publish("setData",formFields,h.id),u.publish("processStep",STEP_CREDIT_CARD)}else c!=n?u.publish("processStep",STEP_VALIDATION):f!=t&&u.publish("processStep",STEP_CREDIT_CARD)}),i('input[name="default"]').on("click",function(){if(!this.checked){var e=new r(i("#default-warning"));e.info("Please be aware, this card will not be used for transactions.")}else i("#default-warning").empty()}),dojo.global.handleFormLoad=function(){l&&esri.paymentForm.callCreditCardForm("repopulateCreditCardForm",[l])},dojo.global.handleFormFailure=function(){showFatalError()},dojo.global.handleFormSumission=function(e){l=e,c=v(e)},dojo.global.handleFormValiationFailure=function(){i("#submitBtn").attr("disabled",!1),S("Please validate all credit card fields")},dojo.global.handleFormCompletion=function(e,t){t=t||0,e==="true"?t!==0?(u.publish("setData",formFields,t),u.publish("processStep",STEP_CREDIT_CARD)):(i("#submitBtn").val("Add Payment Method"),i("#submitBtn").removeAttr("disabled"),S()):(i("#submitBtn").val("Add Payment Method"),i("#submitBtn").removeAttr("disabled"),S())},esri.paymentForm=new p,esri.paymentForm});