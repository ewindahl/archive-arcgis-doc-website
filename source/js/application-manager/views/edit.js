define(["SessionManager","dojo/_base/declare","dojo/_base/event","dojo/_base/lang","dojo/query","dojo/dom-form","dojo/dom-construct","Quoin/View","dijit/focus","dojo/text!/templates/application-manager/edit","dojo/NodeList-manipulate","dojo/NodeList-dom","dojo/NodeList-traverse","ApplicationManager/helpers/handlebars"],function(e,t,n,r,i,s,o,u,a,f){var l=t([u],{templateString:f,editing:!0,events:{"#application-info button click":"updateApplication","#application-redirects #update-redirect-urls click":"updateRedirects","#redirect-urls .removeRedirect click":"removeRedirect",".addRedirect click":"addRedirectInput",".deleteApp click":"deleteApp",".show-keys click":"showKeys",".quick-register click":"quickRegister","#date_range change":"updateUsageGraph"},bindings:{title:function(){i("h2",this.domNode).text(this.model.get("title")),i("input[name=title]",this.domNode).attr("value",this.model.get("title"))},description:"textarea[name=description] value",id:function(){var e=["usage-summary","info","redirect-urls","delete"];for(var t=e.length-1;t>=0;t--)i(".app-"+e[t]+" a",this.domNode).attr("href",this.model.get("id")+"/"+e[t])},creditsUsed:function(){i(".lastThirtyDays").innerHTML(this.model.get("creditsUsed")||"")},averagePerDay:function(){i(".averagePerDay").innerHTML(this.model.get("averagePerDay")||"")},type:function(){i(".applicationType",this.domNode).innerHTML(this.model.get("type")||"Application")},folderInfo:function(){this.model.get("folderInfo")&&i(this.applicationInfo).append("<dt>Folder</dt><dd>"+this.model.get("folderInfo").currentFolder.title+"</dd>")},tags:function(){var e=this.model.get("tags");i("input[name=tags]",this.domNode).attr("value",e),i(this.tags).empty();if(e.length&&e[0])for(var t=0;t<e.length;t++)i(this.tags).append("<span class='tag icon-tag'>"+e[t]+"</span>");else i(this.tags).append("<small>No Tags</small>")},apnsSandboxCert:"textarea[name=apnsSandboxCert] value",apnsProdCert:"textarea[name=apnsProdCert] value",gcmApiKey:"input[name=gcmApiKey] value"},updateUsageGraph:function(e){var t=i("#date_range").attr("value")[0];i("#loader1").removeClass("hide"),this.model.getUsageData(t).then(r.hitch(this,function(){this.createGraph()}))},show:function(e){i(".current",this.domNode).removeClass("current"),i(".app-"+e,this.domNode).addClass("current"),i("#chart-1").empty()},updateApplication:function(e){n.stop(e);var t=s.toObject("application-info");this.publish("application:update",this.model.get("id"),t)},updateRedirects:function(e){n.stop(e);var t=s.toObject("application-redirects");this.publish("application:update",this.model.get("id"),t)},updatePushCerts:function(e){n.stop(e);var t=s.toObject("application-push-certs");this.publish("application:update",this.model.get("id"),t)},removeRedirect:function(e){i(e.target).parent().remove()},addRedirectInput:function(e){i(this.redirectUrls).removeClass("empty").children(".placeholder").remove(),o.place('<div class="redirect"><input type="text" name="redirect_uris" placeholder="http://example.com"><button class="btn caution right removeRedirect">Ã—</button></div>',this.redirectUrls,"last"),a.focus(i("input",this.redirectUrls).last()[0])},deleteApp:function(e){confirm('Are you sure you want to delete "'+this.model.get("title")+'"?')&&this.publish("application:destroy",this.model.get("id"))},renderAuth:function(){this.clientId.innerHTML="<pre><code>"+this.model.get("oAuthInfo").client_id+"</code></pre>",this.clientSecret.innerHTML="<pre><code>"+this.model.get("oAuthInfo").client_secret+"</code></pre>"},quickRegister:function(){this.model.registerApp(!0).then(r.hitch(this,this.renderAuth))},showKeys:function(e){var t;this.model.getOauthInfo().then(r.hitch(this,this.renderAuth),r.hitch(this,function(e){e.message==="Not a registered app"?t="<span>Not registered</span> <button data-application-id='"+this.model.get("id")+"' class='btn small light quick-register'>Register</button>":t="<span class='error-text'>Could not get key info.</span>",this.clientId.innerHTML=t,this.clientSecret.innerHTML=t}))},clearGraph:function(){i("#the-chart").empty().innerHTML("<svg id='chart-1'></svg>")},createGraph:function(){i(".load",this.domNode).addClass("hide");var e=this.model.get("serviceUsage");if(!e.length){i("#the-chart",this.domNode).addClass("hide"),i(".chart-no-data",this.domNode).removeClass("hide");return}i(".chart-no-data",this.domNode).addClass("hide"),i("#the-chart",this.domNode).removeClass("hide");var t=d3.scale.category20();keyColor=function(e,n){return t(e.key)},nv.addGraph(function(){return chart=nv.models.stackedAreaChart().x(function(e){return e[0]}).y(function(e){return e[1]}).color(keyColor).showControls(!1).tooltips(!0),chart.xAxis.tickFormat(function(e){return d3.time.format("%b %e")(new Date(e))}),chart.yAxis.tickFormat(d3.format(",.2f")),d3.select("#chart-1").datum(e).call(chart),nv.utils.windowResize(chart.update),chart})}}),c=new l;return c.subscribe("application:deleted",function(){this.use(null)}),c});