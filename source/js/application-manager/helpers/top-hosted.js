define(["Config","SessionManager","dojo/Deferred","dojo/_base/lang","dojo/promise/all"],function(e,t,n,r,i){function s(e){var t=[];for(k=0;k<e.length;k++){var n=parseFloat((parseFloat(e[k].credits[0][1])+parseFloat(e[k].credits[1][1])).toFixed(2));(n>0||!e[k].name)&&t.push({name:e[k].name,credits:n})}t.sort(function(e,t){return t.credits-e.credits}),t.splice(10,t.length-10);for(var r=0;r<t.length;r++)t[r].percent=(t[r].credits/t[0].credits*100).toFixed(0);return t}function o(e){switch(e){case"week":return"Last 7 Days";case"month":return"Last 30 Days";case"half_year":return"Last 6 Months";case"year":return"Last Year"}}function u(e){var t=new Date,n=864e5,r=30*n,i="1d";switch(e){case"week":r=n*7,i="7d";break;case"month":r=n*30,i="30d";break;case"half_year":r=n*183,i="183d";break;case"year":r=n*365,i="365d"}return{vars:"credits",startTime:t.setHours(0,0,0,0)-r,endTime:t.getTime(),groupby:"name",sType:"features",f:"json",period:i}}return{getUsageDataForGraph:function(t,r){var a=new n,f=u(r),l=f;l.sType="features";var c=esri.request({url:e.portal+"/portals/"+t+"/usage",content:l}),h=f;h.sType="tiles";var p=esri.request({url:e.portal+"/portals/"+t+"/usage",content:h});return i({features:c,tiles:p}).then(function(e){var t=e.features.data.concat(e.tiles.data),n;if(!t.length){a.resolve({timeRangePhrase:o(r),mostCredits:0,usageData:[]});return}n=s(t),a.resolve({timeRangePhrase:o(r),mostCredits:n[0].credits,usageData:n})}),a}}});