require(["Config","dojo/query","dojo/dom-form","dojo/dom-construct","dojo/io-query","dojo/ready","dojo/cookie"],function(e,t,n,r,i,s,o){function h(){esri.request({url:e.billing+"/password/reset/validate",content:{reset_token:dojo.trim(u),f:"json"},handleAs:"json"}).then(function(e){t("#loading-message").addClass("hide"),e.code==200&&e.status=="success"?(l=e.username,t("#reset-password-wrapper").removeClass("hide")):t("#invalid-code").removeClass("hide")},function(e){t("#loading-message").addClass("hide"),y()})}function p(){t("#submitBtn").attr("disabled",!0),esri.request({url:e.billing+"/password/reset",content:{reset_token:u,password:a.password,f:"json"},handleAs:"json"},{usePost:!0}).then(function(e){console.info(e),t("#loading-message").addClass("hide"),e.code==200&&e.status=="success"?d(l,a.password):g()},function(e){g()})}function d(t,n){var r=Number(new Date)+TOKEN_EXPIRATION_MS;esri.request({url:e.portal+"/rest/generateToken",content:{username:t,password:n,referer:location.host,expiration:TOKEN_EXPIRATION_MIN,f:"json"},handleAs:"json"},{usePost:!0}).then(function(e){e.hasOwnProperty("token")?(c=e.token,console.info("token generated"),v(r)):m()},function(e){m()})}function v(n){esri.request({url:e.portal+"/rest/portals/self/",content:{token:c,f:"json"},handleAs:"json"}).then(function(e){try{o("esri_auth",JSON.stringify({accountId:e.id,culture:e.culture,email:e.user.username,expires:n,region:e.region,role:e.user.role,token:c,urlKey:e.urlKey}),{expires:n,path:"/",domain:".arcgis.com"}),t("#reset-password-wrapper").addClass("hide"),t("#success").removeClass("hide")}catch(r){m()}},function(e){m()})}function m(){t("#reset-password-wrapper").addClass("hide"),t("#reset-confirmation").removeClass("hide")}function g(e){e=e||"We were unable to complete your request at this time.",r.create("div",{"class":"error-message server-error",innerHTML:e},"submitBtn","before"),t("#submitBtn").attr("disabled",!1)}function y(){t("#error-message").removeClass("hide")}TOKEN_EXPIRATION_DAYS=14,TOKEN_EXPIRATION_MIN=TOKEN_EXPIRATION_DAYS*24*60,TOKEN_EXPIRATION_MS=TOKEN_EXPIRATION_MIN*60*1e3;var u,a,f=/^([a-zA-Z\d]{8,28})$/,l="",c="";s(function(){var e=window.location.search,t=e.substring(e.indexOf("?")+1,e.length),n=i.queryToObject(t);if(!n.hasOwnProperty("hashcode")){window.location="/"+dojo.locale.substr(0,2)+"/forgot-password";return}u=n.hashcode,h()}),t("#reset-password-form").on("submit",function(e){e.preventDefault(),e.stopImmediatePropagation(),a=n.toObject("reset-password-form"),t(".error-message.server-error").remove(),t(".error").removeClass("error");if(!a.password.match(f)){t("input[name='password']").addClass("error"),g("Please enter a valid password.");return}if(a.password!==a.confirmationPassword){t("input[name='confirmationPassword']").addClass("error"),g("The password and confirmation values do NOT match");return}p()})});