require(["Config","SessionManager","dojo/query","dojo/dom-form","dojo/dom-construct","dojo/io-query","dojo/ready"],function(e,t,n,r,i,s,o){function l(){n("#submitBtn").attr("disabled",!0)}function c(){t.subscription&&t.subscription.primaryProduct.id&&n("input[name='plan_id']").forEach(function(e){e.value==t.subscription.primaryProduct.id&&n(e).attr("checked",!0)})}function h(){esri.request({url:e.billing+"/subscription/products",content:{f:"json"},handleAs:"json"}).then(function(e){e.code=="200"?(u=e.products,p()):w()},function(e){w()})}function p(){var e;n("#content-wrapper").removeClass("hide"),u.forEach(function(t){e=i.create("label",{"class":"plan-option"},"plans"),listItem=i.create("div",{"class":"plan-price",innerHTML:'<input type="radio" name="plan_id" value="'+t.id+'">&#36;'+t.price+"<small> / month</small>"},e),i.create("div",{"class":"plan-credits",innerHTML:t.credits+" Credits"},e);if(t.supportTypes){var n=t.supportTypes.toString().replace(/;/g,"<br>");i.create("div",{"class":"plan-support",innerHTML:n},e)}}),n("#loading-message").addClass("hide"),n("#plan-wrapper").removeClass("hide"),c(),n("input[name='plan_id']").on("click",d)}function d(e){var r=v(e.target.value);if(r.id!=t.subscription.primaryProduct.id){n("#submitBtn").attr("disabled",!1);if(t.subscription.type.toLowerCase()=="trial developer")return;r.price>t.subscription.primaryProduct.price?(n("#downgrade").addClass("hide"),n("#upgrade").removeClass("hide")):r.price<t.subscription.primaryProduct.price&&(n("#upgrade").addClass("hide"),n("#downgrade").removeClass("hide"))}else n("#upgrade").addClass("hide"),n("#downgrade").addClass("hide"),n("#submitBtn").attr("disabled",!0)}function v(e){var t;return u.some(function(n){if(n.id==e)return t=n,!0}),t}function m(){window.location="/"+dojo.locale.substr(0,2)+"/account/payment-methods?orderprocess=true"}function g(){y(),c();if(t.subscription.type.toLowerCase()!="trial developer"){var e=t.subscription.allowOverages===!0?"allow":"disallow";n("#"+e).removeClass("hide"),n("#overage-wrapper").removeClass("hide"),n("#cancel-wrapper").removeClass("hide")}else i.destroy("overage-wrapper"),n("#cancel-plan").addClass("hide"),n("#cancel-wrapper").removeClass(),n("#trial-greeting").removeClass("hide")}function y(){esri.request({url:e.billing+"/storage/",content:{id:f,userToken:t.token(),f:"json"},handleAs:"json"}).then(function(e){e.code==200?a=JSON.parse(e.value):a={}},function(e){a={}})}function b(r,i){esri.request({url:e.billing+"/storage/",content:{id:f,userToken:t.token(),value:r,f:"json"},handleAs:"json"},{usePost:!0}).then(function(e){typeof i=="function"&&i.call()},function(e){n("#submitBtn").attr("disabled",!1),E()})}function w(){n("#loading-message").addClass("hide"),n("#plan-wrapper").addClass("hide"),n("#error-message").removeClass("hide")}function E(e){e=e||"We were unable to complete your request at this time.",i.create("div",{"class":"error-message server-error",innerHTML:e},"submitBtn","before")}var u=[],a,f="subscription-signup";t.queue(g),o(function(){l();var e=!0;e?n("#submitBtn").attr("value","Update Plan"):n("#submitBtn").attr("value","Change Plan"),h()}),n("#more-details").on("click",function(e){e.preventDefault(),n(e.target).addClass("hide"),n("#overage-details").removeClass("hide")}),n("#plan-form").on("submit",function(e){e.preventDefault(),e.stopImmediatePropagation(),n(".error-message.server-error").remove(),n(".error").removeClass("error"),formFields=r.toObject("plan-form"),n("#submitBtn").attr("disabled",!0),typeof a!="object"&&(a={}),a.selectedPlan=formFields.plan_id,b(JSON.stringify(a),m)})});