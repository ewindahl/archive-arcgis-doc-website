define(["SessionManager","Config","dojo/_base/declare","dojo/_base/lang","dojo/Deferred","Quoin/Model"],function(e,t,n,r,i,s){return n([s],{path:t.portal+"/portals/"+e.orgId()+"/usage",loaded:!1,getters:{usageByService:function(){this.on("usage:loaded",function(e){})}},constructor:function(e){return this.set("loaded",!1),this.sync(e)},sync:function(e){var t={vars:"credits",startTime:Math.round(new Date-2592e6),endTime:Math.round(new Date),groupby:"stype",f:"json",period:"1d"};return e.application_id&&(t.appId=e.application_id,this.set("forApplication",!0)),esri.request({url:this.path,content:t}).then(r.hitch(this,function(e){function r(e){for(var t=0;t<e.length;t++)e[t][0]=parseFloat(e[t][0]),e[t][1]=parseFloat(e[t][1])}function i(e,i){if(n[i]){var s=n[i].credits,o={key:e,values:s};r(o.values),t.push(o)}}function c(e){for(var n=0;n<e.length;n++){e[n][0]=a[n][0];var r=0;for(var i=0;i<t.length;i++)r+=t[i].values[n][1];e[n][1]=r}}function h(e){for(var t=1;t<e.length;t++){var n=t-1;e[t][1]=e[t][1]+e[n][1]}}this.set("data",e);var t=[],n=this.data.data;for(k=0;k<n.length;k++){var s=n[k].stype;s=="geocode"&&(s="Geocoding"),s=="tiles"&&(s="Tiles"),s=="portal"&&(s="Portal"),s=="features"&&(s="Hosted Data"),s=="nasimpleroute"&&(s="Routing"),i(s,k)}var o=[],u=[{key:"Usage",values:[]}],a=t[0].values,f=u[0].values;for(var l=0;l<a.length;l++)f[l]=[0,0];c(f),h(f);var p=parseInt(f.length,10)-1,d=parseFloat(f[p][1]);averagePerDay=d/p,averagePerDay=Math.round(averagePerDay*100)/100,d=Math.round(d*10)/10,this.set("serviceUsage",t),this.set("totalUsage",u),this.set("creditsUsed",d),this.set("averagePerDay",averagePerDay),this.set("loaded",!0)}),function(e){console.log("error")})}})});