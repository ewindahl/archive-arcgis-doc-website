define(["Config","dojo/Deferred","dojo/_base/lang"],function(e,t,n){return{getUsageDataForGraph:function(n,r,i){var s=new t,o=new Date,u=864e5,a=30*u,f="Last 30 Days",l="1d";switch(r){case"week":a=u*7,f="Last 7 Days",l="6h";break;case"month":a=u*30,f="Last 30 Days",l="1d";break;case"half_year":a=u*183,f="Last 6 Months",l="1w";break;case"year":a=u*365,f="Last Year",l="1w"}var c={vars:"credits",startTime:o.setHours(0,0,0,0)-a,endTime:o.getTime(),groupby:"stype",f:"json",period:l};return i&&(c.appId=i),esri.request({url:e.portal+"/portals/"+n+"/usage",content:c}).then(function(e){function u(e){for(var t=0;t<e.length;t++)e[t][0]=parseFloat(e[t][0]),e[t][1]=parseFloat(e[t][1]);return e}function a(e,n){var r=0;for(var i=0;i<n.length;i++)r+=parseFloat(n[i][1]);r>.25&&t.push({key:e,values:u(n)})}var t=[],n=e.data,r=0,i=0,o=n.length?n[0].credits.length-1:0;if(n.length){for(k=0;k<n.length;k++){var l;switch(n[k].stype){case"geocode":l="Geocoding";break;case"tiles":l="Tiles";break;case"portal":l="Portal";break;case"features":l="Hosted Data";break;case"nasimpleroute":l="Simple Routing";break;case"natsproute":l="Optimized Routing";break;case"nacfroute":l="Closest Facility Routing";break;case"naservicearea":l="Service Area Requests";break;case"demogmaps":l="Demographic Maps";break;case"geoenrich":l="Geoenrichment";break;case"geotrigger":l="Geotriggers";break;case"spanalysis":l="Spatial Analysis";break;case"applogin":l="App Login";break;default:l=n[k].stype}a(l,n[k].credits)}for(var c=0;c<n.length;c++)for(var h=0;h<n[c].credits.length;h++)r+=parseFloat(n[c].credits[h][1]);i=Math.round(r/o*100)/100,r=Math.round(r*100)/100}s.resolve({timeRangePhrase:f,usageData:t,creditsUsed:r,averagePerDay:i})},function(e){s.reject(e)}),s}}});