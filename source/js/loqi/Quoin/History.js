define(["dojo/_base/declare","dojo/_base/lang","dojo/query","dojo/dom-construct","dojo/on","dojo/_base/array","dojo/Evented","Quoin/Base"],function(e,t,n,r,i,s,o,u){var a=/^[#\/]|\s+$/g,f=/^\/+|\/+$/g,l=/msie [\w.]+/,c=/\/$/,h=e("Quoin.History",[o,u],{interval:50,started:!1,handlers:[],getHash:function(){var e=window.location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(e,t){if(e==null)if(this._hasPushState||!this._wantsHashChange||t){e=window.location.pathname;var n=this.root.replace(c,"");e.indexOf(n)||(e=e.substr(n.length))}else e=this.getHash();return e.replace(a,"")},start:function(e){if(this.started)throw new Error("Backbone.history has already been started");this.started=!0,this.options=t.mixin({},{root:"/"},this.options,e),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var n=this.getFragment(),s=document.documentMode,o=l.exec(navigator.userAgent.toLowerCase())&&(!s||s<=7);this.root=("/"+this.root+"/").replace(f,"/"),o&&this._wantsHashChange&&(this.iframe=r("iframe",{src:"javascript:0",tabIndex:-1,style:"display:none;"},"body"),this.navigate(n)),this._hasPushState?this._handler=i(window,"popstate",t.hitch(this,this.checkUrl)):this._wantsHashChange&&"onhashchange"in window&&!o?this._handler=i(window,"hashchange",t.hitch(this,this.checkUrl)):this._wantsHashChange&&(this._checkUrlInterval=setInterval(t.hitch(this,this.checkUrl),this.interval)),this.fragment=n;var u=window.location,c=u.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!c)return this.fragment=this.getFragment(null,!0),window.location.replace(this.root+window.location.search+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&c&&u.hash&&(this.fragment=this.getHash().replace(a,""),window.history.replaceState({},document.title,this.root+this.fragment+u.search));if(!this.options.silent)return this.loadUrl()},stop:function(){this._handler.remove(),clearInterval(this._checkUrlInterval),h.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(e){var t=this.getFragment();t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe)));if(t===this.fragment)return!1;this.iframe&&this.navigate(t),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(e){var t=this.fragment=this.getFragment(e),n=s.some(this.handlers,function(e){if(e.route.test(t))return e.callback(t),!0});return n},navigate:function(e,t){if(!this.started)return;if(!t||t===!0)t={trigger:t};e=this.getFragment(e||"");if(this.fragment===e)return;this.fragment=e;var n=this.root+e;if(this._hasPushState)window.history[t.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return window.location.assign(n);this._updateHash(window.location,e,t.replace),this.iframe&&e!==this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,e,t.replace))}t.trigger&&this.loadUrl(e)},_updateHash:function(e,t,n){if(n){var r=e.href.replace(/(javascript:|#).*$/,"");e.replace(r+"#"+t)}else e.hash="#"+t}});return new h});